export RUSTC := rustc
RUSTDOC := rustdoc
RUSTFLAGS := -O
BUILDDIR := build
INSTALL_DIR := %PREFIX%

DGLR_SRC := $(shell find src -name '*.rs' -print)
DGLR_LIB := $(BUILDDIR)/$(shell $(RUSTC) --crate-file-name src/dglr.rs)

all: $(DGLR_LIB)

$(BUILDDIR):
	mkdir -p $(BUILDDIR)

$(DGLR_LIB): $(DGLR_SRC) | $(BUILDDIR)
	$(RUSTC) $(RUSTFLAGS) --out-dir $(BUILDDIR) src/dglr.rs

doc:	$(DGLR_SRC)
	$(RUSTDOC) $(DGLR_SRC)

install: $(DGLR_LIB)
	install $(DGLR_LIB) $(INSTALL_DIR)

test:	$(DGLR_SRC)
	$(RUSTC) $(RUSTFLAGS) --test --out-dir $(BUILDDIR) src/dglr.rs && \
	RUST_LOG=dglr=4 $(BUILDDIR)/dglr

clean:
	rm -rf $(BUILDDIR)

dist-clean:	clean
	rm -rf Makefile

print-target:
	@echo $(DGLR_LIB)

.PHONY: all doc clean dist-clean install run print-target
